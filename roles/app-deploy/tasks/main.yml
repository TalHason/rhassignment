---
#install env programs
- hosts : all
  become: true
  tasks:
          - name: update OS
            yum:
              name: '*'
              state: latest
            register: updated

          - name: enable python '3' repo
            command : amazon-linux-extras enable python3.8

          - name: install git epel python docker
            yum:
              name:
                - git
                - amazon-linux-extras
                - python3.8
                - docker  
              state: latest

          - name: reboot servers after update
            reboot:
              reboot_timeout: 3600
            when: updated.changed

- hosts: ansible
  become: true
  tasks:
      - name: Create folder for Git repo
          file:
            path: /home/ec2-user/web-p      
      - name: Get stuff from git
          git:
            repo: git@github.com:TalHason/rhassignment.git main
            dest: /home/ec2-user/web-p/
          sudo_user: ec2-user   
      - name: build container image
        docker_image:
        name: flask-server:latest
        build: 
          path: /home/ec2-user/web-p/Docker
          source: build
        state: present
      - name: Log into DockerHub
        docker_login:
          username: talhason
          password: @3-Z6.dW~vcmt2#
          email: talhason3105@gmail.com
      - name: push image to docker hub repo
        community.docker.docker_image:
          name: flask-server:latest
          repository: talhason/rhassignment:flaskserver
          push: yes
          source: local

- hosts: web
  become: true
  tasks:
      - name: start docker service demon
        ansible.builtin.service:
          name: docker
          state: started
      - name: Log into DockerHub
        docker_login:
          username: talhason
          password: @3-Z6.dW~vcmt2#
          email: talhason3105@gmail.com
      - name: start the flask server docker image
          docker_container:
            image: flask-server:latest 
            name: nginx
            state: started
            auto_remove: true
            ports:
              - "5000:5000"
- hosts: haproxy
  become: true
  tasks:
      - name: install HAproxy
        yum:
         name: haproxy
         state: latest
      - name: get haproxy conf file from git
          get_url:
            url: https://github.com/TalHason/rhassignment/blob/main/haproxy/haproxy.cfg
            dest: /tmp/
            mode: '0640'
      - name: copy new haproxy conf to server etc folder
        ansible.builtin.copy:
          src: /tmp/haproxy.cfg
          dest: /etc/haproxy/
          force: yes
      - name: start the haProxy Deamon
        ansible.builtin.service:
          name: haproxy
          state: started





